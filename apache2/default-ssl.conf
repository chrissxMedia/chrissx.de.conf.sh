<VirtualHost *:443>
        # Sets our domain
        ServerAlias chrissx.ga

        # Set custom 404 page
        ErrorDocument 404 /404.html

        # Just a silly page for "testing"
        Redirect 500 /foo/bar

        # Some aliases
        Redirect permanent /papers /papers.html
        Redirect permanent /gpf1 /gpf/gpf1.txt
        Redirect permanent /not_yet /not_yet.html

        SecRuleEngine On
        SecAuditEngine on
        SecAuditLog /var/log/apache2/website-audit.log
        SecRequestBodyAccess on
        SecAuditLogParts ABIFHZ
        SecDefaultAction "nolog,noauditlog,allow,phase:2"
        SecRule REQUEST_METHOD "^POST$" "chain,allow,phase:2,id:123"
        SecRule REQUEST_URI ".*" "auditlog"

        # Enables HTTP/2.0 and HTTP/1.1 and HTTP/1.0 as fallback
        Protocols h2 http/1.1 http/1.0

        ServerAdmin chrissx@chrissx.ga
        DocumentRoot /var/www/html

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        DumpIOInput On
        DumpIOOutput On
        LogLevel dumpio:info

        #   Enable TLS for this virtual host.
        SSLEngine on

        #   Our LetsEncrypt cert
        SSLCertificateFile /etc/letsencrypt/live/chrissx.ga/cert.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/chrissx.ga/privkey.pem
        SSLCertificateChainFile /etc/letsencrypt/live/chrissx.ga/chain.pem

        <FilesMatch "\.(cgi|shtml|phtml|php)$">
                        SSLOptions +StdEnvVars
        </FilesMatch>
        <Directory /usr/lib/cgi-bin>
                        SSLOptions +StdEnvVars
        </Directory>

        #   o ssl-unclean-shutdown:
        #        This forces an unclean shutdown when the connection is closed, i.e. no
        #        SSL close notify alert is send or allowed to received.  This violates
        #        the SSL/TLS standard but is needed for some brain-dead browsers. Use
        #        this when you receive I/O errors because of the standard approach where
        #        mod_ssl sends the close notify alert.
        #   o ssl-accurate-shutdown:
        #        This forces an accurate shutdown when the connection is closed, i.e. a
        #        SSL close notify alert is send and mod_ssl waits for the close notify
        #        alert of the client. This is 100% SSL/TLS standard compliant, but in
        #        practice often causes hanging connections with brain-dead browsers. Use
        #        this only for browsers where you know that their SSL implementation
        #        works correctly.
        BrowserMatch "MSIE [2-6]" nokeepalive ssl-unclean-shutdown \
                downgrade-1.0 force-response-1.0

        # Upgrade HTTP/1.1 and HTTP/1.0 to HTTP/2.0 if possible
        H2Upgrade on

        # Set DiffieHellman parameters
        SSLOpenSSLConfCmd DHParameters "/etc/ssl/private/dhparams.pem"

        # Set encryption to secure only (disables everything except
        # TLS 1.2 and 1.3)
        # Manually disables TLS 1.3...Apache sucks
        SSLProtocol all -SSLv2 -SSLv3

        # Use server's preferred cipher suite
        SSLHonorCipherOrder On

        # Turn off compression because of CRIME
        SSLCompression off

        # Change "Powered by PHP2.6.9!!11eleven!" to "Powered by masafakas!!"
        Header always set X-Powered-By "Powered by chrissx Media!"

        Header always set Referrer-Policy "no-referrer-when-downgrade"

        # Force TLS with preload (it's in Chromium's list now)
        Header always set Strict-Transport-Security "max-age=31536000;includeSubDomains;preload"

        # Only allow iframes from us
        Header always set X-Frame-Options SAMEORIGIN

        # Tell browser to not find a...js when there is none
        Header always set X-Content-Type-Options "nosniff"

        # If the browser detects an XSS it stops rendering the page
        Header always set X-XSS-Protection "1;mode=block"

        # Don't accept imgs, scripts and styles from anywhere else
        # than this server or google
        Header always set Content-Security-Policy "default-src 'self';script-src 'self';style-src 'self' fonts.googleapis.com;img-src 'self' i.imgflip.com;font-src 'self' fonts.gstatic.com;media-src 'self';object-src 'self';frame-src 'self';worker-src 'self';frame-ancestors 'self';form-action 'self';upgrade-insecure-requests;disown-opener;sandbox allow-forms allow-same-origin allow-scripts allow-top-navigation;reflected-xss block;manifest-src 'self' 'self';referrer origin;"

        # Best cipher suite config on the planet xD
        # (it's really quite good)
        SSLCipherSuite TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-PSK-AES256-CBC-SHA384
#ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256
</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
